import './App.css';

import { useState, useEffect } from 'react';
import AuthPage from './components/AuthPage';
import ChatPage from './components/ChatPage'; 
import './components/buttons/Buttons.css';
import apiClient from './api';
import { UserDto } from './types';

function App() {
  const [token, setToken] = useState<string | null>(() => {
    return localStorage.getItem('token');
  });
  const [currentUser, setCurrentUser] = useState<UserDto | null>(null);
  const [loadingUser, setLoadingUser] = useState<boolean>(false);

  useEffect(() => {
    const fetchUser = async () => {
      setLoadingUser(true);

      if (token) {
        try {
          const response = await apiClient.get<UserDto>('/users/me');
          setCurrentUser(response.data);
        } catch (error) {
          console.error("Invalid token, logging out.", error);
          handleLogout();
        } finally {
          setLoadingUser(false);
        }
      } else {
        setLoadingUser(false);
      }
    };

    fetchUser();
  }, [token]);


  const handleLogin = (newToken: string) => {
    setToken(newToken);
    localStorage.setItem('token', newToken);
  };

  const handleLogout = () => {
    setToken(null);
    setCurrentUser(null);
    localStorage.removeItem('token');
  };

  if (loadingUser) {
    return <div>Loading...</div>;
  }

  return (
    <main className="main">
      <header className="header">
        <div className="header__logo-wrapper">
          <svg className="header__logo" viewBox="0 0 638 135" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M38.9302 53.7337C38.9302 39.5084 50.4627 27.9767 64.6879 27.9767H92.3261C95.739 27.9767 98.5062 30.7432 98.5062 34.1561C98.5062 37.569 95.739 40.3355 92.3261 40.3355H64.6879C57.2886 40.3355 51.2898 46.3343 51.2898 53.7337C51.2898 61.133 57.2886 67.1311 64.6879 67.1311H75.0662C89.3841 67.1311 101.029 78.6666 101.165 92.9838C101.318 109.217 86.7727 121.651 70.7612 118.973L59.6614 117.117C54.0573 116.179 48.3579 118.129 44.5024 122.303L34.963 132.629C30.4353 137.53 22.2464 134.326 22.2464 127.654V115.81C22.2463 113.733 21.1578 111.807 19.3779 110.736C7.35327 103.499 8.2751e-05 90.4903 0 76.4559V63.3072C0 28.5272 28.0729 0.268637 62.8521 0.0393452L68.6774 0.000742362L68.7167 0L68.7553 0.000742362L80.0021 0.0690397C114.832 0.279877 142.956 28.5744 142.956 63.4051V79.9331C142.956 101.083 127.783 119.186 106.958 122.881C103.598 123.477 100.39 121.236 99.7935 117.876C99.1973 114.516 101.438 111.308 104.799 110.711C119.723 108.063 130.597 95.0904 130.597 79.9331V63.4051C130.597 35.3711 107.961 12.5976 79.9272 12.4279L68.7212 12.3596L62.9337 12.3982C34.9484 12.5826 12.3588 35.3212 12.3588 63.3072V76.4559C12.3589 86.1548 17.4411 95.1447 25.7511 100.146C30.9652 103.284 34.2545 108.797 34.577 114.832L35.424 113.916C42.1072 106.682 51.986 103.302 61.6999 104.926L72.7997 106.783C81.2291 108.193 88.8868 101.646 88.8058 93.1004C88.7342 85.5632 82.6038 79.4907 75.0662 79.4906H64.6879C50.4627 79.4906 38.9303 67.9589 38.9302 53.7337Z" fill="white"/>
            <path d="M626.869 97.6399C621.803 97.6399 617.856 96.3599 615.029 93.7999C612.203 91.1866 610.789 87.3199 610.789 82.1999V44.4399H623.269V82.0399C623.269 83.8533 623.749 85.2666 624.709 86.2799C625.669 87.2399 626.976 87.7199 628.629 87.7199C630.603 87.7199 632.283 87.1866 633.669 86.1199L637.029 94.9199C635.749 95.8266 634.203 96.5199 632.389 96.9999C630.629 97.4266 628.789 97.6399 626.869 97.6399ZM604.149 64.5199V54.9199H633.989V64.5199H604.149Z" fill="white"/>
            <path d="M588.694 97.0001V88.6001L587.894 86.7601V71.7201C587.894 69.0534 587.068 66.9734 585.414 65.4801C583.814 63.9867 581.334 63.2401 577.974 63.2401C575.681 63.2401 573.414 63.6134 571.174 64.3601C568.988 65.0534 567.121 66.0134 565.574 67.2401L561.094 58.5201C563.441 56.8667 566.268 55.5867 569.574 54.6801C572.881 53.7734 576.241 53.3201 579.654 53.3201C586.214 53.3201 591.308 54.8667 594.934 57.9601C598.561 61.0534 600.374 65.8801 600.374 72.4401V97.0001H588.694ZM575.574 97.6401C572.214 97.6401 569.334 97.0801 566.934 95.9601C564.534 94.7867 562.694 93.2134 561.414 91.2401C560.134 89.2667 559.494 87.0534 559.494 84.6001C559.494 82.0401 560.108 79.8001 561.334 77.8801C562.614 75.9601 564.614 74.4667 567.334 73.4001C570.054 72.2801 573.601 71.7201 577.974 71.7201H589.414V79.0001H579.334C576.401 79.0001 574.374 79.4801 573.254 80.4401C572.188 81.4001 571.654 82.6001 571.654 84.0401C571.654 85.6401 572.268 86.9201 573.494 87.8801C574.774 88.7867 576.508 89.2401 578.694 89.2401C580.774 89.2401 582.641 88.7601 584.294 87.8001C585.948 86.7867 587.148 85.3201 587.894 83.4001L589.814 89.1601C588.908 91.9334 587.254 94.0401 584.854 95.4801C582.454 96.9201 579.361 97.6401 575.574 97.6401Z" fill="white"/>
            <path d="M535.542 53.3201C538.955 53.3201 541.995 54.0135 544.662 55.4001C547.382 56.7335 549.515 58.8135 551.062 61.6401C552.608 64.4135 553.382 67.9868 553.382 72.3601V97.0001H540.902V74.2801C540.902 70.8135 540.128 68.2535 538.582 66.6001C537.088 64.9468 534.955 64.1201 532.182 64.1201C530.208 64.1201 528.422 64.5468 526.822 65.4001C525.275 66.2001 524.048 67.4535 523.142 69.1601C522.288 70.8668 521.862 73.0535 521.862 75.7201V97.0001H509.382V37.6401H521.862V65.8801L519.062 62.2801C520.608 59.4001 522.822 57.1868 525.702 55.6401C528.582 54.0935 531.862 53.3201 535.542 53.3201Z" fill="white"/>
            <path d="M480.79 97.96C476.47 97.96 472.443 97.2667 468.71 95.88C465.03 94.44 461.83 92.4134 459.11 89.8C456.39 87.1867 454.257 84.12 452.71 80.6C451.217 77.08 450.47 73.2134 450.47 69C450.47 64.7867 451.217 60.92 452.71 57.4C454.257 53.88 456.39 50.8134 459.11 48.2C461.883 45.5867 465.11 43.5867 468.79 42.2C472.47 40.76 476.497 40.04 480.87 40.04C485.723 40.04 490.097 40.8934 493.99 42.6C497.937 44.2534 501.243 46.7067 503.91 49.96L495.59 57.64C493.67 55.4534 491.537 53.8267 489.19 52.76C486.843 51.64 484.283 51.08 481.51 51.08C478.897 51.08 476.497 51.5067 474.31 52.36C472.123 53.2134 470.23 54.44 468.63 56.04C467.03 57.64 465.777 59.5334 464.87 61.72C464.017 63.9067 463.59 66.3334 463.59 69C463.59 71.6667 464.017 74.0934 464.87 76.28C465.777 78.4667 467.03 80.36 468.63 81.96C470.23 83.56 472.123 84.7867 474.31 85.64C476.497 86.4934 478.897 86.92 481.51 86.92C484.283 86.92 486.843 86.3867 489.19 85.32C491.537 84.2 493.67 82.52 495.59 80.28L503.91 87.96C501.243 91.2134 497.937 93.6934 493.99 95.4C490.097 97.1067 485.697 97.96 480.79 97.96Z" fill="white"/>
            <path d="M426.401 97.6401C421.495 97.6401 417.175 96.6801 413.441 94.7601C409.761 92.8401 406.908 90.2267 404.881 86.9201C402.855 83.5601 401.841 79.7467 401.841 75.4801C401.841 71.1601 402.828 67.3467 404.801 64.0401C406.828 60.6801 409.575 58.0667 413.041 56.2001C416.508 54.2801 420.428 53.3201 424.801 53.3201C429.015 53.3201 432.801 54.2267 436.161 56.0401C439.575 57.8001 442.268 60.3601 444.241 63.7201C446.215 67.0267 447.201 71.0001 447.201 75.6401C447.201 76.1201 447.175 76.6801 447.121 77.3201C447.068 77.9067 447.015 78.4667 446.961 79.0001H412.001V71.7201H440.401L435.601 73.8801C435.601 71.6401 435.148 69.6934 434.241 68.0401C433.335 66.3867 432.081 65.1067 430.481 64.2001C428.881 63.2401 427.015 62.7601 424.881 62.7601C422.748 62.7601 420.855 63.2401 419.201 64.2001C417.601 65.1067 416.348 66.4134 415.441 68.1201C414.535 69.7734 414.081 71.7467 414.081 74.0401V75.9601C414.081 78.3067 414.588 80.3867 415.601 82.2001C416.668 83.9601 418.135 85.3201 420.001 86.2801C421.921 87.1867 424.161 87.6401 426.721 87.6401C429.015 87.6401 431.015 87.2934 432.721 86.6001C434.481 85.9067 436.081 84.8667 437.521 83.4801L444.161 90.6801C442.188 92.9201 439.708 94.6534 436.721 95.8801C433.735 97.0534 430.295 97.6401 426.401 97.6401Z" fill="white"/>
            <path d="M383.379 97.0001V37.6401H395.859V97.0001H383.379Z" fill="white"/>
            <path d="M355.984 97.6401C352.358 97.6401 349.184 96.8401 346.464 95.2401C343.744 93.6401 341.611 91.2134 340.064 87.9601C338.571 84.6534 337.824 80.4934 337.824 75.4801C337.824 70.4134 338.544 66.2534 339.984 63.0001C341.424 59.7467 343.504 57.3201 346.224 55.7201C348.944 54.1201 352.198 53.3201 355.984 53.3201C360.038 53.3201 363.664 54.2534 366.864 56.1201C370.118 57.9334 372.678 60.4934 374.544 63.8001C376.464 67.1067 377.424 71.0001 377.424 75.4801C377.424 80.0134 376.464 83.9334 374.544 87.2401C372.678 90.5467 370.118 93.1067 366.864 94.9201C363.664 96.7334 360.038 97.6401 355.984 97.6401ZM330.544 112.52V53.9601H342.464V62.7601L342.224 75.5601L343.024 88.2801V112.52H330.544ZM353.824 87.4001C355.904 87.4001 357.744 86.9201 359.344 85.9601C360.998 85.0001 362.304 83.6401 363.264 81.8801C364.278 80.0667 364.784 77.9334 364.784 75.4801C364.784 72.9734 364.278 70.8401 363.264 69.0801C362.304 67.3201 360.998 65.9601 359.344 65.0001C357.744 64.0401 355.904 63.5601 353.824 63.5601C351.744 63.5601 349.878 64.0401 348.224 65.0001C346.571 65.9601 345.264 67.3201 344.304 69.0801C343.344 70.8401 342.864 72.9734 342.864 75.4801C342.864 77.9334 343.344 80.0667 344.304 81.8801C345.264 83.6401 346.571 85.0001 348.224 85.9601C349.878 86.9201 351.744 87.4001 353.824 87.4001Z" fill="white"/>
            <path d="M304.158 53.3201C307.571 53.3201 310.585 54.0134 313.198 55.4001C315.865 56.7334 317.945 58.8134 319.438 61.6401C320.985 64.4134 321.758 67.9867 321.758 72.3601V97.0001H309.278V74.2801C309.278 70.8134 308.558 68.2534 307.118 66.6001C305.678 64.9467 303.651 64.1201 301.038 64.1201C299.225 64.1201 297.598 64.5467 296.158 65.4001C294.718 66.2001 293.598 67.4267 292.798 69.0801C291.998 70.7334 291.598 72.8401 291.598 75.4001V97.0001H279.118V74.2801C279.118 70.8134 278.398 68.2534 276.958 66.6001C275.571 64.9467 273.571 64.1201 270.958 64.1201C269.145 64.1201 267.518 64.5467 266.078 65.4001C264.638 66.2001 263.518 67.4267 262.718 69.0801C261.918 70.7334 261.518 72.8401 261.518 75.4001V97.0001H249.038V53.9601H260.958V65.7201L258.718 62.2801C260.211 59.3467 262.318 57.1334 265.038 55.6401C267.811 54.0934 270.958 53.3201 274.478 53.3201C278.425 53.3201 281.865 54.3334 284.798 56.3601C287.785 58.3334 289.758 61.3734 290.718 65.4801L286.318 64.2801C287.758 60.9201 290.051 58.2534 293.198 56.2801C296.398 54.3067 300.051 53.3201 304.158 53.3201Z" fill="white"/>
            <path d="M227.376 97V53.96H239.856V97H227.376ZM233.616 47.96C231.322 47.96 229.456 47.2934 228.016 45.96C226.576 44.6267 225.856 42.9734 225.856 41C225.856 39.0267 226.576 37.3734 228.016 36.04C229.456 34.7067 231.322 34.04 233.616 34.04C235.909 34.04 237.776 34.68 239.216 35.96C240.656 37.1867 241.376 38.7867 241.376 40.76C241.376 42.84 240.656 44.5734 239.216 45.96C237.829 47.2934 235.962 47.96 233.616 47.96Z" fill="white"/>
            <path d="M198.04 97.96C193.56 97.96 189.267 97.3734 185.16 96.2C181.053 94.9734 177.747 93.4 175.24 91.48L179.64 81.72C182.04 83.4267 184.867 84.84 188.12 85.96C191.427 87.0267 194.76 87.56 198.12 87.56C200.68 87.56 202.733 87.32 204.28 86.84C205.88 86.3067 207.053 85.5867 207.8 84.68C208.547 83.7734 208.92 82.7334 208.92 81.56C208.92 80.0667 208.333 78.8934 207.16 78.04C205.987 77.1334 204.44 76.4134 202.52 75.88C200.6 75.2934 198.467 74.76 196.12 74.28C193.827 73.7467 191.507 73.1067 189.16 72.36C186.867 71.6134 184.76 70.6534 182.84 69.48C180.92 68.3067 179.347 66.76 178.12 64.84C176.947 62.92 176.36 60.4667 176.36 57.48C176.36 54.28 177.213 51.3734 178.92 48.76C180.68 46.0934 183.293 43.9867 186.76 42.44C190.28 40.84 194.68 40.04 199.96 40.04C203.48 40.04 206.947 40.4667 210.36 41.32C213.773 42.12 216.787 43.3467 219.4 45L215.4 54.84C212.787 53.3467 210.173 52.2534 207.56 51.56C204.947 50.8134 202.387 50.44 199.88 50.44C197.373 50.44 195.32 50.7334 193.72 51.32C192.12 51.9067 190.973 52.68 190.28 53.64C189.587 54.5467 189.24 55.6134 189.24 56.84C189.24 58.28 189.827 59.4534 191 60.36C192.173 61.2134 193.72 61.9067 195.64 62.44C197.56 62.9734 199.667 63.5067 201.96 64.04C204.307 64.5734 206.627 65.1867 208.92 65.88C211.267 66.5734 213.4 67.5067 215.32 68.68C217.24 69.8534 218.787 71.4 219.96 73.32C221.187 75.24 221.8 77.6667 221.8 80.6C221.8 83.7467 220.92 86.6267 219.16 89.24C217.4 91.8534 214.76 93.96 211.24 95.56C207.773 97.16 203.373 97.96 198.04 97.96Z" fill="white"/>
          </svg>
        </div>
        {currentUser && (
          <div className="header__user">
            <span>Logged in as: <strong>{currentUser.username}</strong></span>
            <button onClick={handleLogout} className="header__user-button button--red">Logout</button>
          </div>
        )}
      </header>
      {token && currentUser ? (
        <ChatPage token={token} currentUser={currentUser} />
      ) : (
        <AuthPage onLogin={handleLogin} />
      )}
    </main>
  );
}

export default App;